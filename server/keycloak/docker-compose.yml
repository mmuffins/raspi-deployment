---
version: '3.8'

networks:
  reverse-proxy:
    external: true

services:
  keycloak:
    image: jboss/keycloak
    env_file: ~/dockercompose/keycloak/keycloak.env
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - reverse-proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=reverse-proxy
      - traefik.http.routers.keycloak.rule=Host(`keycloak.docker.localhost`)
      - traefik.http.routers.keycloak.entrypoints=web
      - traefik.http.services.keycloak.loadbalancer.server.port=8080

  keycloak-db:
    env_file: ~/dockercompose/keycloak/keycloak.env
    image: postgres:10.1
    volumes:
      - ~/docker/data/keycloak/db:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - reverse-proxy

  # keycloak-db-backup:
  #   image: postgres:10.1
  #   env_file: ~/dockercompose/keycloak/keycloak-backup.env
  #   volumes:
  #     - ~/docker/data/keycloak/db-dump:/dump
  #     - /etc/localtime:/etc/localtime:ro
  #   entrypoint: |
  #     bash -c 'bash -s <<EOF
  #     trap "break;exit" SIGHUP SIGINT SIGTERM
  #     sleep 2m
  #     while /bin/true; do
  #       pg_dump -Fc > /dump/dump_\`date +%d-%m-%Y"_"%H_%M_%S\`.psql
  #       (ls -t /dump/dump*.psql|head -n $$BACKUP_NUM_KEEP;ls /dump/dump*.psql)|sort|uniq -u|xargs rm -- {}
  #       sleep $$BACKUP_FREQUENCY
  #     done
  #     EOF'
  #   networks:
  #     - reverse-proxy
